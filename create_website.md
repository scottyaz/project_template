
## Setup a private website for a project

These instructions are adapted from Ben Balter's [jekyll-auth setup instructions](https://github.com/benbalter/jekyll-auth) to meet my specific use when creating restricted access to project website/dashboards. 

Assume that you already have an organization account and a project repository in containing:
- master branch with some code
- .gitignore file

### Create a GitHub Application

1. Navigate to [the GitHub app registration page](https://github.com/settings/applications/new) of your organization.
2. Give your app a name
3. Tell GitHub the URL you want the app to eventually live at. If using a free Heroku account, this will be something like <https://my-site.herokuapp.com>
4. Specify the callback URL; should be like this: <https://my-site.herokuapp.com/auth/github/callback>; note that this is **https**, not http.
5. Hit Save, but leave the page open, you'll need some of the information in a moment

Remember the 'my-site' part for later on when using `heroku create`. Also, my-site is often called 'app-name' in Heroku documentation.

### Create a hk-pages branch

First, we will do a little trick to make a new hk-branch. Following [Github instructions](https://help.github.com/articles/creating-project-pages-using-the-command-line), we will clone a fresh copy of the repo in a temporary directory (here on `~/Desktop/`), create an orphan branch and then make sure there are no files on this branch from the original repo except for the .gitignore file.

    cd ~/Desktop
    git clone https://github.com/username/repository.git
    cd repository
    git checkout --orphan hk-pages
    cp .gitignore ../.gitignore
    git rm -rf .
    cp ../.gitignore .gitignore
    echo "More soon.." > index.html
    git add .
    git commit -a -m "First pages commit"
    git push origin hk-pages
    cd ..
    rm -rf repository


### Add Jekyll Auth to your site

Go back to the original repository and checkout to your `hk-pages` branch (using `git checkout -b hk-pages`). The following steps assume you have Ruby on your computer (and appropriate paths exported).

1. Within your `hk-pages` branch, add `gem 'jekyll-auth'` to your `Gemfile` or if you don't already have a `Gemfile`, create a file called `Gemfile` in the root of your site's repository with the following content:
```ruby
source "https://rubygems.org"
gem 'jekyll-auth'
```
This can be done with the following command:
```bash
printf "source \"https://rubygems.org\"\n\ngem 'jekyll-auth'\n" > Gemfile
```
2. Run `bundle install`. (Note: if you don't have the bundler gem already installed you can install it with `sudo gem install bundler`)
3. Run `bundle exec jekyll-auth new` which will copy the necessary files to set up the server
4. Add and commit the files generated by `jekyll-auth new` to the git repository before continuing
```bash
git add .
git commit -a -m "Setup jekyll-auth"
```


### Create a Github team and fill your `.env` file

Access to the website will be restricted to members of this team through using OAuth.

1. Create a new team for your organisation
2. Create a new token from your personnal account (_Settings > Developer settings > Personal access tokens_). You only need _read:org_ rights. Save it in the `.env` file
```
GITHUB_TOKEN=XXX
```
3. Get your team id with the following command (@orgName/teamName)
```
jekyll-auth team_id --org orgName --team teamName    
```
4. Save your team id in you `.env` file
```
GITHUB_TEAM_ID=XXX
```
5. Go back to the GitHub app registration page and under "OAuth credentials" you will find a Client ID and Client Secret. Add these to the `.env` files under `GITHUB_CLIENT_ID` and `GITHUB_CLIENT_SECRET`.

### Setting up hosting with Heroku

1. Make sure you have [the Heroku toolbelt](https://toolbelt.heroku.com/) installed
2. Run `heroku create my-site` from your site's directory; make sure `my-site` matches what you specified in the GitHub application registration above.
3. `heroku config:set GITHUB_CLIENT_ID=XXX GITHUB_CLIENT_SECRET=XXX GITHUB_TEAM_ID=XXX`
4. `git push heroku hk-pages:master`
5. `heroku open` to open the site in your browser

### Custom domain to `my-site-epicentre.msf.fr`

1. Visit the [Heroku website](https://dashboard.heroku.com) and select your app called `my-site`
2. Go in _Settings_ and scroll down to _Domains and certificates_
3. Add `my-site-epicentre.msf.fr` as a new domain
4. Email [Fabrice Cezard](mailto:Fabrice.CEZARD@paris.msf.org) and ask him to redirect `my-site-epicentre.msf.fr` to `my-site-epicentre.msf.fr.herokudns.com`
5. __Note that you need to change `https://my-site.herokuapp.com` into `http://my-site-epicentre.msf.fr` in 2 URL of the Github application settings for redirection to work__


### Refences
 
- https://github.com/benbalter/jekyll-auth
- https://github.com/benbalter/jekyll-auth/issues/29
- http://fabian-kostadinov.github.io/2014/11/13/installation-of-jekyll-auth/
